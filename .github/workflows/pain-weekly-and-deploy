name: pain-weekly-and-deploy

on:
  schedule:
    # Mondays 07:00 UTC ≈ 12:30 IST — tweak as you like
    - cron: "0 7 * * MON"
  workflow_dispatch:

permissions:
  contents: write  # needed to push to gh-pages

concurrency:
  group: pain-weekly
  cancel-in-progress: false

jobs:
  run-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Run bot (generates abstracts.html + sends email)
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          NCBI_TOOL: pain-weekly-bot
          NCBI_EMAIL: ${{ secrets.NCBI_EMAIL }}
          NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
          ABSTRACTS_BASE_URL: ${{ secrets.ABSTRACTS_BASE_URL }}
        run: |
          python bot.py
          test -f abstracts.html || (echo "abstracts.html not found; bot may have skipped generation" && exit 1)
                - name: Show working tree (debug)
        run: |
          ls -la
          echo "abstracts.html size:"; wc -c abstracts.html

      - name: Publish abstracts.html to gh-pages
        permissions:
          contents: write
        run: |
          git fetch origin
          # Create gh-pages if missing
          if ! git ls-remote --exit-code --heads origin gh-pages; then
            git checkout --orphan gh-pages
            rm -rf .
          else
            git checkout gh-pages
            git rm -rf . || true
          fi

          cp abstracts.html index.html
          touch .nojekyll
          echo "# Pain Literature Abstracts" > README.md

          git add index.html .nojekyll README.md
          git -c user.name="github-actions[bot]" \
              -c user.email="github-actions[bot]@users.noreply.github.com" \
              commit -m "Update abstracts page ($(date -u +%F))" || echo "No changes to commit"
          git push -f origin gh-pages

      - name: Prepare gh-pages worktree
        run: |
          git fetch origin
          # Create gh-pages if it doesn't exist
          if ! git ls-remote --exit-code --heads origin gh-pages; then
            git checkout --orphan gh-pages
            rm -rf .
            echo "<html><body>Initializing…</body></html>" > index.html
            git add index.html
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "Initialize gh-pages"
            git push -f origin gh-pages
          fi

      - name: Publish abstracts.html to gh-pages
        run: |
          # Switch to a clean tree of gh-pages
          git checkout gh-pages
          git rm -rf . || true
          cp abstracts.html index.html
          # Ensure Pages serves without Jekyll processing
          touch .nojekyll
          # Optional: simple landing README
          echo "# Pain Literature Abstracts" > README.md
          git add index.html .nojekyll README.md
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "Update abstracts page"
          git push -f origin gh-pages
